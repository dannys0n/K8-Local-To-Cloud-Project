âš ï¸ This README was automatically generated by AI (keyword-retrieval RAG â†’ OpenRouter â†’ LLM) every push to main via Actions and may be inaccurate.
Model: stepfun/step-3.5-flash:free
Generated: 2026-02-17 07:58 UTC

---
# Game Server System

A distributed game server system with Kubernetes-based matchmaking and authoritative game servers.  
**Status:** Early development (v0.1.0)

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Clients   â”‚â”€â”€â”€â–¶â”‚     Proxy    â”‚â”€â”€â”€â–¶â”‚   Backend API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   Game Server Pod   â”‚
                                          â”‚  (per match/session)â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

1. **Backend API** (`src/app/backend/main.py`)  
   FastAPI service that:
   - Receives matchmaking requests (`/match/join`)
   - Manages Redis-based matchmaking queue
   - Creates/deletes game server pods via Kubernetes API
   - Tracks sessions in PostgreSQL and Redis

2. **Game Server** (`src/app/game-server/main.py`)  
   TCP server running in dedicated pods:
   - Authoritative game state management
   - State transitions: `open` â†’ `running` â†’ `stop`
   - Custom match duration (set by first client)
   - Auto-shutdown when match ends or all clients disconnect

3. **Proxy** (`src/app/proxy/` - not included)  
   Entry point for clients, routes to backend and game servers

4. **Storage**:
   - **PostgreSQL**: Match history (`matches` table)
   - **Redis**: Matchmaking queue, active session tracking

5. **Kubernetes Integration** (`src/app/backend/k8s_game_server.py`):
   - Creates game server deployments/pods per session
   - Waits for pod readiness before returning connection details
   - Automatic cleanup via Kubernetes

## ğŸš€ Quick Start

### Prerequisites
- Docker
- kubectl
- kind (Kubernetes in Docker)

### 1. Start Local Cluster

```bash
# Create KIND cluster and deploy dependencies
make cluster
make databases  # Deploys Redis + PostgreSQL
```

### 2. Build & Deploy

```bash
# Build Docker images
make game-build

# Load images into KIND cluster
make game-load-images

# Deploy backend + proxy
make game-backend
make game-proxy
```

### 3. Port Forward

```bash
# Expose proxy locally on port 8080
make proxy-port-forward-local
```

### 4. Run Load Test

```bash
# Spawn 50 clients (default)
make game-load-local

# Custom client count
CLIENTS=100 make game-load-local

# With spawn rate (10 clients/second) and custom duration
CLIENTS=200 SPAWN_RATE=10 MATCH_DURATION=60 python3 src/app/load/main.py
```

## ğŸ“‹ API Reference

### POST `/match/join`
Request:
```json
{
  "player_id": "unique-player-id"
}
```

Response (when matched):
```json
{
  "session_id": "uuid",
  "players": ["player1", "player2"],
  "connect_host": "game-server-xxxx",
  "connect_port": 8080
}
```

Response (queued):
```json
{
  "session_id": "pending-xxxx",
  "status": "queued"
}
```

### Game Server Protocol (TCP)

Each game server pod listens on port 8080 (configurable via `PORT` env).

**Client â†’ Server Commands:**
- `GET_STATE` â†’ `STATE <open|running|stop>`
- `GET_RUNNING_LENGTH` â†’ `RUNNING_LENGTH <seconds>`
- `REQUEST_MATCH <seconds>` â†’ Sets match duration (first client wins)

**Server â†’ Client Broadcasts:**
- `STATE <state>` on state change
- `RUNNING_LENGTH <seconds>` when match starts

## ğŸ§ª Load Testing

The `src/app/load/` tool simulates realistic client behavior:

```bash
cd src/app/load

# Run with defaults (50 clients, 30s matches)
python3 main.py 50

# Advanced options
python3 main.py 100 \
  --url http://localhost:8080 \
  --match-duration 60 \
  --spawn-rate 5
```

### Environment Variables
- `TARGET_URL`: Backend/proxy URL (default: `http://localhost:8080`)
- `MATCH_DURATION`: Match length in seconds (default: `30.0`)
- `SPAWN_RATE`: Clients per second (default: `0` = all at once)
- `GAME_SERVER_HOST_OVERRIDE`: Override game server host (for local testing)

## ğŸ“Š Database Schema

### PostgreSQL (`matches` table)
```sql
CREATE TABLE matches (
  session_id TEXT PRIMARY KEY,
  players_json TEXT NOT NULL,
  backend_pod TEXT,
  game_server_pod TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  ended_at TIMESTAMPTZ
);
```

### Redis Keys
- `matchmaking_queue`: List of player IDs
- `player:queue_ts:<player_id>`: Queue join timestamp (expires 1h)
- `active_sessions`: Set of active session IDs
- `session:<session_id>:pod/host/port`: Session connection details (expire 1h)

## ğŸ”§ Configuration

Key settings (from `src/app/backend/settings.py`, not shown but referenced):
- `NAMESPACE`: Kubernetes namespace (default: `default`)
- `SESSION_SIZE`: Players per match (full session)
- `MIN_PARTIAL_SESSION_SIZE`: Minimum players for partial match
- `FLUSH_WAIT_SECONDS`: Max wait time before flushing partial session
- `DATABASE_URL`: PostgreSQL connection string
- `REDIS_HOST/REDIS_PORT`: Redis connection

## ğŸ§¹ Cleanup

```bash
# Tear down entire cluster
make down

# Clear database data only
make clear-databases
```

## ğŸ› Troubleshooting

```bash
# Check pod status
kubectl get pods -A

# View backend logs
kubectl logs -l app=backend -c backend

# Check Redis connection
make ping-redis

# Check PostgreSQL connection
make ping-postgres

# Free local DB ports if conflicts
make free-local-db-ports
```

## ğŸ“ Project Structure

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ backend/          # Matchmaking API + Kubernetes controller
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ storage.py    # DB/Redis client
â”‚   â”‚   â””â”€â”€ k8s_game_server.py
â”‚   â”œâ”€â”€ game-server/      # TCP game server (runs in pods)
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ proxy/            # Reverse proxy (not provided)
â”‚   â””â”€â”€ load/             # Load testing tool
â”‚       â”œâ”€â”€ client.py
â”‚       â”œâ”€â”€ lifecycle.py
â”‚       â””â”€â”€ main.py
â”œâ”€â”€ databases/            # K8s manifests for Redis/Postgres
â”œâ”€â”€ k8s/
â”‚   â””â”€â”€ base/             # Deployments for backend/proxy
â””â”€â”€ scripts/              # Cluster setup/teardown scripts
```

## ğŸ“ Notes

- Game server pods are created dynamically per match and deleted when matches end
- Backend uses "partial sessions" if not enough players within `FLUSH_WAIT_SECONDS`
- All times/timestamps in UTC
- Designed for local KIND development; adapt for production cloud deployments
- Health check endpoint: `/health` (returns `{"status": "ok"}` or `{"status": "degraded"}`)

---

**Developed for:** Distributed game session management with Kubernetes  
**License:** (Not specified in provided files)
